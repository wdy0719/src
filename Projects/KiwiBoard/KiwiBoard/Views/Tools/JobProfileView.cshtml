@{

    //[Route("JobProfile/{apCluster}/{environment}/{runtime}/{dereferencedRuntime}/{jobId}")]
    ViewBag.jobId = ViewContext.RouteData.Values["jobId"];
    ViewBag.dereferencedRuntime = ViewContext.RouteData.Values["dereferencedRuntime"];
    ViewBag.environment = ViewContext.RouteData.Values["environment"];
    ViewBag.apCluster = ViewContext.RouteData.Values["apCluster"];
    ViewBag.runtime = ViewContext.RouteData.Values["runtime"];
    Layout = "~/Views/Shared/_Layout.cshtml";

    ViewBag.Title = "Job Profile - " + ViewBag.jobId;
}

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Job Profile<small><i id="info">&nbsp;&nbsp; - Job Id: @ViewBag.JobId</i></small></h3>
    </div>
    <div class="panel-body">

        @*<div class="row" style="padding:5px 15px 5px 15px;">
                    <div id="profileLog" class="well wordwrap small" style="min-height:300px;">Loading...</div>
            </div>*@

        <div class="row" style="padding:5px 15px 5px 15px;">
           
            <div id="toolbar">
                <h4 style="margin-bottom:0px">Job Processes</h4>
           
            </div>
            <table id="table_Profile" class="bootstrap-table small"
                   data-toggle="table"
                   data-search="true"
                   data-card-view="false" data-show-columns="true"
                   data-toolbar="#toolbar">
                <thead>
                    <tr class="active">
                        @*<th data-field="Vertices" data-sortable="false" data-formatter="caretsFormatter" data-events="caretsDataEvents"></th>*@
                        <th data-field="StageName" data-sortable="false">Stage</th>
                        <th data-field="VertexName" data-sortable="false">Vertex</th>
                        <th data-field="Machine" data-sortable="false">Machine</th>
                        @*<th data-field="RuntimeStats" data-sortable="false" data-visible="false">RuntimeStats</th>*@
                        <th data-field="Name" data-sortable="false">Process Name</th>
                        <th data-field="Guid" data-sortable="false">Process Guid</th>
                        <th data-field="ProcessStartTime" data-sortable="false">Process StartTime</th>
                        <th data-field="ProcessCompleteTime" data-sortable="false">Process CompleteTime</th>
                        <th data-field="ExitStatus" data-sortable="false">ExitStatus</th>
                        <th data-field="IsCriticalPath" data-sortable="false">IsCriticalPath</th>
                        <th data-field="TotalDataRead" data-sortable="false">TotalDataRead</th>
                        <th data-field="TotalDataWritten" data-sortable="false">TotalDataWritten</th>
                    </tr>
                </thead>
            </table>
            @*<span><small>&nbsp;&nbsp;*- Red lines are critical path.</small></span>*@
            <table class="small">
                <tr>
                    <td><strong style="padding-right:30px;">*-  Enable highlights: </strong>@*<input type="checkbox" id="hlCriticalPath" checked><span class="text-warning" style="padding-right:30px;">Critical path</span>*@</td>
                    <td><input type="checkbox" id="hlUpVertex" checked><span class="text-success" style="padding-right:30px;">Up Vertices</span></td>
                    <td><input type="checkbox" id="hlDownVertex" checked><span class="text-info" style="padding-right:30px;">Down Vertices</span></td>
                </tr>
            </table>
        </div>

        <div class="row" style="padding:5px 15px 5px 15px;">
            <h4 style="margin-bottom:0px">RuntimeStats</h4>
            <pre>
            <code id="runtimeState" class="lang-xml"></code>
            </pre>
        </div>

        <div class="row" style="padding:5px 15px 5px 15px;">
            <h4 style="margin-bottom:0px">Algebra</h4>
            <pre>
            <code id="algebraCode" class="lang-xml"></code>
            </pre>
        </div>
    </div>
</div>



<style>
    .wordwrap {
        white-space: pre-wrap; /* css-3 */
        white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        word-wrap: break-word; /* Internet Explorer 5.5+ */
    }
</style>

@section style
{
    <link href="@Url.Content("~/Content/highlight/styles/github.css")" rel="stylesheet" type="text/css" />
}

@section Scripts
{
    <script src="@Url.Content("~/Content/highlight/highlight.pack.js")"></script>
    @*<script>hljs.initHighlightingOnLoad();</script>*@

    <script>
    var preSelected = null;
    $(document).ready(function () {

        loadProfileObj();

        registryOnClickRowEvent();
    });

    function loadProfileObj(url) {
        var url = "/api/phxutils/GetProfileProcesses/@ViewBag.apCluster/@ViewBag.environment/@ViewBag.runtime/@ViewBag.dereferencedRuntime/@ViewBag.jobId";
        var profileTable = $('#table_Profile');

        ajaxindicatorstart();
        profileTable.bootstrapTable('showLoading');
        $.getJSON(url, function () { })
            .done(function (data) {
                if (data==null || data.ProfileLocation == "")
                    return;

                // set machine info
                $('#info').text($('#info').text() + ";      Profile on machine: " + data.ProfileLocation);

                // show algebra
                if (data.Algebra != null) {
                    $('#algebraCode').text(data.Algebra.replace(/\<br\/\>/g, '\n').replace(/\r/g, '').replace(/\t/g, '  '));
                    highlightBlock();
                }

                // load data to table
                profileTable.bootstrapTable('load', data.Processes);
                var rows = $('#table_Profile tbody tr')
                var cols = rows.first().children().length;

                // hightlight critical path
                //$.each(rows, function (index, row) {
                //    if ($.inArray(data.Processes[index].Guid, data.CriticalPath) > -1) {
                //        rows[index].className = 'warning';
                //    }
                //});

                //

            })
            .error(function (err) {
                alert('Loading data error: ' + err.responseText);
                $('#profileLog').html("Error: " + err.responseText);
            })
            .always(function () {
                ajaxindicatorstop();
                profileTable.bootstrapTable('hideLoading');
            });
    }

    function registryOnClickRowEvent() {
        $('#table_Profile').on('click-row.bs.table', function (e, name, args) {

            ajaxindicatorstart();

            try {
                if (preSelected != null) {
                    preSelected.removeClass('active');
                }
                preSelected = args.first();
                preSelected.addClass('active');

                // show runtimestats
                if (name.RuntimeStats !== null) {
                    $('#runtimeState').text(name.RuntimeStats.replace(/\<br\/\>/g, '\n').replace(/\r/g, '').replace(/\t/g, '  '));
                    highlightBlock();
                }

                $('#table_Profile tbody tr.success').removeClass('success');
                $('#table_Profile tbody tr.info').removeClass('info');
                var rows = $('#table_Profile tbody tr');
                var upVertices = name.UpVertices;
                var downVertices = name.DownVertices;
                var hlUpVertexEnabled = $('#hlUpVertex').prop('checked');
                var hlDownVertexEnabled = $('#hlDownVertex').prop('checked');
                $.each(rows, function (index, row) {

                    // hightlight up vertices
                    if (hlUpVertexEnabled && upVertices.length != 0 && $.inArray(row.cells[1].innerText, upVertices) > -1) {
                        rows[index].className = 'success ' + rows[index].className;
                        return;
                    }

                    // hightlight down vertices
                    if (hlDownVertexEnabled && downVertices.length != 0 && $.inArray(row.cells[1].innerText, downVertices) > -1) {
                        rows[index].className = 'info ' + rows[index].className;;
                        return
                    }
                });
            }
            finally {
                ajaxindicatorstop();
            }
        });
    }

    function highlightBlock() {
        $('pre code').each(function (i, block) {
            hljs.highlightBlock(block);
        });
    }

    function ajaxindicatorstart() {
        $('body').css('cursor', 'wait');
        $("input").prop('disabled', true);
        $("button").prop('disabled', true);
    }

    function ajaxindicatorstop() {
        $("input").prop('disabled', false);
        $("button").prop('disabled', false);
        $('body').css('cursor', 'auto');
    }
    </script>

    @*<script>

            $(document).on('click', '.glyphicon-plus', function () {

                var curRow = $(this).parentsUntil('tr').parent();
                var curIndex = curRow.attr('data-index');
                var nextRow = curRow.next('tr');
                if (nextRow.length == 0 || nextRow.attr('data-index') != null) {
                    var nextRow = $('<tr class="active"><td colspan="2">asf</td></tr>');
                    nextRow.insertAfter(curRow);
                }

            });

                function loadProfile() {
                var url = "/api/phxutils/GetProfile/@ViewBag.apCluster/@ViewBag.environment/@ViewBag.runtime/@ViewBag.dereferencedRuntime/@ViewBag.jobId";

                ajaxindicatorstart();
                $.getJSON(url, function () { })
                    .done(function (data) {
                        if (data.Machine != "") {
                            // set machine info
                            $('#info').text($('#info').text() + ";      Machine: " + data.Machine);

                            // set profile
                            // var formattedProfile = FormatProfileString(data.Profile);
                            // $('#profileLog').text(formattedProfile);
                            DisplayProfileString(data.Profile);
                            //  FormatProfileString(data.Profile);

                        } else {
                            $('#profileLog').html("Not Found.");
                        }
                    })
                    .error(function (err) {
                        $('#profileLog').html("Error: " + err.responseText);
                    })
                    .always(function () {
                        ajaxindicatorstop();
                    });
            }

            function ExpandProfileTable() {
                var tableRows = $('#table_Profile tbody tr');


                $.each(tableRows, function (index, row) {


                });
            }

            function caretsFormatter(value, row, index) {
                if (value != null && Object.prototype.toString.call(value) === '[object Array]') {
                    // insert table to next hidden row

                    var curRow = $('#table_Profile tbody tr:nth-child(' + index + ')');
                    var nextRow = $('<tr class="active"><td colspan="2">asf</td></tr>')  //$('<tr><td col="2"><table class="bootstrap-table small" data-toggle="table"><tr class="active"><th data-field="Name" data-sortable="false">Name</th></tr><thead></thead></table></td></tr>')

                    // nextRow.insertAfter(curRow);
                }

                return getExpandBtnHtml();
            }

            window.caretsDataEvents = {
                'click .glyphicon-plus': function (e, value, row, index) {
                    if ($(this).hasClass('glyphicon-minus')) {
                        // collapse next tr
                        $(this).parentsUntil('tr').parent().next('tr').hide();
                    } else {
                        // expand next tr
                        $(this).parentsUntil('tr').parent().next('tr').show();
                    }

                    $(this).toggleClass('glyphicon-minus');
                }
            };

            function getExpandBtnHtml() {
                return [
                    '<a class="glyphicon glyphicon-plus" href="javascript:void(0)" style="text-decoration: none">',
                    '</a>'
                ].join('');
            }

            function getCollapseBtnHtml() {
                return [
                    '<a class="glyphicon glyphicon-minus" href="javascript:void(0)" style="text-decoration: none">',
                    '</a>'
                ].join('');
            }


            function parseProfileString(profileStr) {
                var profile = [];
                $.each(profileStr.split("\n"), function (i, line) {
                    if (line == "") return;
                    var title = line.substring(0, line.indexOf(","));
                    var tmp = line.substring(title.length + 1)
                    var time = tmp.substring(0, tmp.indexOf(","));
                    var content = tmp.substring(tmp.indexOf(",") + 1);

                    profile.push({ Title: title, Time: time, Content: content });
                });

                return profile;
            }

            function DisplayProfileString(profileStr) {
                var profileDiv = $('#profileLog');
                profileDiv.html('');

                $.each(profileStr.split("\n"), function (i, line) {
                    if (line == "") return;
                    var title = line.substring(0, line.indexOf(","));

                    profileDiv.append($('<strong>' + title + '</strong>'));

                    var content = line.substring(title.length + 1);
                    if (content.match(/(>)(<)(\/*)/g)) {
                        content = content.replace('<', '\r\n<');
                        content = content.replace(/\<br\/\>/g, '').replace(/\\"/g, '').replace(/\r/g, '').replace(/\t/g, '');
                        content = formatXml(content);
                        // content = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/ /g, '&nbsp;');
                    }

                    var code = $('<pre><code class="lang-xml"></code></pre>');
                    code.children('code').text(content);
                    profileDiv.append(code);
                });

                $('pre code').each(function (i, block) {
                    hljs.highlightBlock(block);
                });

            }

            function FormatProfileString(profileStr) {

                var formatted = "";
                $.each(profileStr.split("\n"), function (i, line) {
                    if (line == "") return;
                    var title = line.substring(0, line.indexOf(","));

                    var content = line.substring(title.length);
                    if (content.match(/(>)(<)(\/*)/g)) {
                        content = content.replace('<', '\r\n<');
                        content = content.replace(/\<br\/\>/g, '').replace(/\\"/g, '').replace(/\r/g, '').replace(/\t/g, '');
                        content = formatXml(content);
                        content = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/ /g, '&nbsp;');
                    }

                    formatted += '<strong>' + title + '</strong>' + content + '<hr style="margin-top:0" />';

                });

                $('#profileLog').html(formatted);
            }

            function formatXml(xml) {

                var formatted = '';
                var reg = /(>)(<)(\/*)/g;
                xml = xml.replace(reg, '$1\r\n$2$3');
                var pad = 0;

                jQuery.each(xml.split('\r\n'), function (index, node) {
                    var indent = 0;
                    if (node.match(/.+<\/\w[^>]*>$/)) {
                        indent = 0;
                    }
                    else if (node.match(/^<\/\w/)) {
                        if (pad != 0) {
                            pad -= 1;
                        }
                    }
                    else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
                        indent = 1;
                    }
                    else {
                        indent = 0;
                    }
                    var padding = '';
                    for (var i = 0; i < pad; i++) {
                        padding += '  ';
                    }
                    formatted += padding + node + '\r\n';
                    pad += indent;
                });

                return formatted;
            }

        </script>*@
}